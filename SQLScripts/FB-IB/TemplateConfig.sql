SET NAMES UTF8;

/******************************************************************************/
/***      Following SET SQL DIALECT is just for the Database Comparer       ***/
/******************************************************************************/
SET SQL DIALECT 3;


/******************************************************************************/
/***                               Generators                               ***/
/******************************************************************************/

CREATE GENERATOR DCL_SCRIPTS_NEXT_ID;
CREATE GENERATOR GEN_DCL_ACTIVE_USERS_ID;
CREATE GENERATOR GEN_DCL_USER_LOGIN_HISTORY_ID;
CREATE GENERATOR GEN_INI_PROFILES_ID;
CREATE GENERATOR DCL_MAIN_GENERATOR_ID;

/******************************************************************************/
/***                           Stored procedures                            ***/
/******************************************************************************/

SET TERM ^ ;

CREATE OR ALTER PROCEDURE ADD_MENU_ITEM_TO_ROLE (
    ROLEID INTEGER,
    MENUITEMID INTEGER)
RETURNS (
    ISAPPEND INTEGER)
AS
BEGIN
  SUSPEND;
END^


CREATE OR ALTER PROCEDURE COPY_ROLE (
    ROLEIDFROM INTEGER,
    ROLEIDTO INTEGER)
AS
BEGIN
  EXIT;
END^


CREATE OR ALTER PROCEDURE DEL_ROLE_AND_MENU (
    ROLEID INTEGER)
AS
BEGIN
  EXIT;
END^


CREATE OR ALTER PROCEDURE DEL_ROLE_MENU (
    ROLEID INTEGER)
AS
BEGIN
  EXIT;
END^


CREATE OR ALTER PROCEDURE FIRST_DAY_OF_MONTH (
    ADATE DATE)
RETURNS (
    RESULT DATE)
AS
BEGIN
  SUSPEND;
END^


CREATE OR ALTER PROCEDURE IS_NUMBER (
    A_VALUE VARCHAR(32))
RETURNS (
    RESULT INTEGER)
AS
BEGIN
  SUSPEND;
END^


CREATE OR ALTER PROCEDURE ROLESMENU_IS_CORRECT
RETURNS (
    NUMSEQ INTEGER,
    DCLNAME VARCHAR(50),
    IDENT INTEGER,
    ROLE_ID INTEGER,
    ROLE_NAME VARCHAR(50))
AS
BEGIN
  SUSPEND;
END^


SET TERM ; ^

/******************************************************************************/
/***                                 Tables                                 ***/
/******************************************************************************/

CREATE TABLE DCL_ACTIVE_USERS (
    AU_ID                   INTEGER NOT NULL,
    ACTIVE_USER_ID          INTEGER,
    ACTIVE_USER_HOST        VARCHAR(50),
    ACTIVE_USER_IP          VARCHAR(15),
    ACTIVE_USER_DCL_VER     VARCHAR(12),
    ACTIVE_USER_LOGIN_TIME  TIMESTAMP
);

CREATE TABLE DCL_GLOBAL_PARAMS (
    PARAM_ID        INTEGER NOT NULL,
    PARAM_CAPT      VARCHAR(80),
    PARAM_NAME      VARCHAR(80) NOT NULL,
    PARAM_VALUE     VARCHAR(255),
    PARAM_USERID    INTEGER,
    PROGRAMM_PARAM  SMALLINT
);

CREATE TABLE DCL_INI_PROFILES (
    INI_ID           INTEGER NOT NULL,
    INI_USER_ID      INTEGER,
    INI_DIALOG_NAME  VARCHAR(50),
    INI_TYPE         INTEGER DEFAULT 1,
    INI_PARAM_VALUE  BLOB SUB_TYPE 1 SEGMENT SIZE 2048
);

CREATE TABLE DCL_NOTIFYCATIONS (
    NOTIFY_ID      INTEGER NOT NULL,
    NOTIFY_TIME    TIMESTAMP,
    NOTIFY_ACTION  INTEGER,
    NOTIFY_STATE   INTEGER DEFAULT 0,
    USER_ID        INTEGER,
    NOTIFY_TEXT    VARCHAR(255),
    ADD_DATE       TIMESTAMP
);

CREATE TABLE DCL_ROLES (
    ROLESID           INTEGER NOT NULL,
    ROLENAME          VARCHAR(20),
    LONGROLENAME      VARCHAR(30),
    SHOWINLIST        SMALLINT,
    ROLE_ACCESSLEVEL  SMALLINT
);

CREATE TABLE DCL_ROLES_TO_USERS (
    RU_ID      INTEGER NOT NULL,
    RU_USERID  INTEGER,
    RU_ROLEID  INTEGER
);

CREATE TABLE DCL_ROLESMENU (
    ROLEID      INTEGER NOT NULL,
    MENUITEMID  INTEGER,
    RM_ID       INTEGER NOT NULL
);

CREATE TABLE DCL_SCRIPTS (
    NUMSEQ   INTEGER NOT NULL,
    DCLNAME  VARCHAR(50),
    DCLTEXT  BLOB SUB_TYPE 1 SEGMENT SIZE 80,
    COMMAND  VARCHAR(80),
    IDENT    INTEGER,
    PARENT   INTEGER,
    UPDATES  TIMESTAMP,
    ACTINON  CHAR(1)
);

CREATE TABLE DCL_TEMPLATES (
    TEID            INTEGER NOT NULL,
    TEMPL_NAME      VARCHAR(40) NOT NULL,
    TEMPL_DATA      BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    TEMPL_DATATYPE  INTEGER
);

CREATE TABLE DCL_USER_LOGIN_HISTORY (
    UL_ID           INTEGER NOT NULL,
    UL_USER_ID      INTEGER,
    UL_LOGIN_TIME   TIMESTAMP,
    UL_LOGOFF_TIME  TIMESTAMP,
    UL_HOST_NAME    VARCHAR(50),
    UL_HOST_IP      VARCHAR(15),
    UL_DCL_VER      VARCHAR(12)
);

CREATE TABLE DCL_USERS (
    UID                 INTEGER NOT NULL,
    DCL_USER_NAME       VARCHAR(20),
    DCL_LONG_USER_NAME  VARCHAR(30),
    DCL_USER_PASS       VARCHAR(35),
    DCL_ROLE            INTEGER,
    SHOWINLIST          SMALLINT,
    ACCESSLEVEL         SMALLINT,
    DBUSER_NAME         VARCHAR(300),
    DBPASS              VARCHAR(40)
);

CREATE TABLE ORGANIZATIONS (
    OID       INTEGER NOT NULL,
    ORG_NAME  VARCHAR(101),
    ORD       SMALLINT,
    MAINORG   SMALLINT
);


/******************************************************************************/
/***                                 Views                                  ***/
/******************************************************************************/


/* View: DCL_ROLESTOMENU */
CREATE VIEW DCL_ROLESTOMENU(
    ROLEID,
    ROLENAME,
    LONGROLENAME,
    MENUITEMID,
    DCLNAME)
AS
select R.ROLESID ROLEID, R.ROLENAME, R.LONGROLENAME, RM.MENUITEMID, D.DCLNAME
from DCL_ROLESMENU RM, DCL_ROLES R, DCL_SCRIPTS D
where R.ROLESID = RM.ROLEID and
      RM.MENUITEMID = D.NUMSEQ;


/* View: V_ATTACHMENTS */
CREATE VIEW V_ATTACHMENTS(
    MON$ATTACHMENT_ID,
    MON$SERVER_PID,
    MON$STATE,
    MON$ATTACHMENT_NAME,
    MON$USER,
    MON$REMOTE_PROTOCOL,
    MON$REMOTE_ADDRESS,
    MON$REMOTE_PID,
    MON$TIMESTAMP,
    MON$GARBAGE_COLLECTION,
    MON$REMOTE_PROCESS,
    MON$REMOTE_HOST,
    MON$REMOTE_OS_USER)
AS
select
    MON$ATTACHMENT_ID,
    MON$SERVER_PID,
    MON$STATE,
    MON$ATTACHMENT_NAME,
    MON$USER,
    MON$REMOTE_PROTOCOL,
    MON$REMOTE_ADDRESS,
    MON$REMOTE_PID,
    MON$TIMESTAMP,
    MON$GARBAGE_COLLECTION,
    MON$REMOTE_PROCESS,
    MON$REMOTE_HOST,
    MON$REMOTE_OS_USER
from MON$ATTACHMENTS a;


INSERT INTO ORGANIZATIONS (OID, ORG_NAME, ORD, MAINORG) VALUES (1, 'Наша организация', NULL, 1);

COMMIT WORK;

INSERT INTO DCL_ROLES (ROLESID, ROLENAME, LONGROLENAME, SHOWINLIST, ROLE_ACCESSLEVEL) VALUES (1, 'Admin', 'Администратор', NULL, 8);
INSERT INTO DCL_ROLES (ROLESID, ROLENAME, LONGROLENAME, SHOWINLIST, ROLE_ACCESSLEVEL) VALUES (2, 'Dir', 'Директор', 1, 5);
INSERT INTO DCL_ROLES (ROLESID, ROLENAME, LONGROLENAME, SHOWINLIST, ROLE_ACCESSLEVEL) VALUES (3, 'Oper', 'Оператор', 1, 4);

COMMIT WORK;

INSERT INTO DCL_USERS (UID, DCL_USER_NAME, DCL_LONG_USER_NAME, DCL_USER_PASS, DCL_ROLE, SHOWINLIST, ACCESSLEVEL, DBUSER_NAME, DBPASS) VALUES (13, 'Oper', 'Оператор', '951', 3, 1, 1, NULL, NULL);
INSERT INTO DCL_USERS (UID, DCL_USER_NAME, DCL_LONG_USER_NAME, DCL_USER_PASS, DCL_ROLE, SHOWINLIST, ACCESSLEVEL, DBUSER_NAME, DBPASS) VALUES (11, 'Admin', 'Администратор', '789', 1, NULL, 8, NULL, NULL);
INSERT INTO DCL_USERS (UID, DCL_USER_NAME, DCL_LONG_USER_NAME, DCL_USER_PASS, DCL_ROLE, SHOWINLIST, ACCESSLEVEL, DBUSER_NAME, DBPASS) VALUES (12, 'Dir', 'Директор', '555', 2, 1, 5, NULL, NULL);

COMMIT WORK;

INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100107, 'Хранилище двоичных данных', NULL, 'BinStore', 1305, 10, '2019-12-18 10:47:15', 'U');

SET BLOBFILE 'TemplateConfig.lob';

INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (1, 'GlobalParams_AP', :h0_42, NULL, NULL, NULL, '2019-12-18 10:51:12', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (2, '-', NULL, NULL, 1340, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100002, 'Roles', :h42_128, NULL, NULL, NULL, '2019-12-18 10:52:48', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100108, 'BinStore', :h16A_2CE, NULL, NULL, NULL, '2019-12-18 11:20:18', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100004, 'Роли', NULL, 'Roles', 10003, 1289, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100109, 'BinStore_Edit_Scr', :h438_21, NULL, NULL, NULL, '2019-12-18 11:21:27', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100110, 'BinStore_Add_Scr', :h459_7, NULL, NULL, NULL, '2019-12-18 11:21:47', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (3, 'Файлы скриптов', NULL, NULL, 1320, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (4, 'Подписать', NULL, 'SignScript', 10012, 1320, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (5, 'Запустить', NULL, 'RunScript', 10010, 1320, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (6, 'Переподписать', NULL, 'ReSignScript', 10014, 1320, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (7, 'RunScript', :h460_21, NULL, NULL, NULL, '2019-12-18 11:24:26', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (8, 'SignScript', :h481_20, NULL, NULL, NULL, '2019-12-18 11:25:00', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (9, 'ReSignScript', :h4A1_22, NULL, NULL, NULL, '2019-12-18 11:25:34', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100111, 'BinStore_Edit_Dlg', :h4C3_F5, NULL, NULL, NULL, '2019-12-18 11:26:50', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100006, 'Global_Params', :h5B8_246, NULL, NULL, NULL, '2019-12-18 11:28:06', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100161, 'TemplateCompress', :h7FE_53, NULL, NULL, NULL, '2019-12-18 11:30:34', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100162, 'TemplateDeCompress', :h851_55, NULL, NULL, NULL, '2019-12-18 11:30:42', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100008, 'InitApp', :h8A6_61, NULL, 40001, NULL, '2019-12-18 11:31:42', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100163, 'TemplateExport', :h907_93, NULL, NULL, NULL, '2019-12-18 11:32:29', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100164, 'TemplateImport', :h99A_89, NULL, NULL, NULL, '2019-12-18 11:32:57', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100010, 'Orgs', :hA23_221, NULL, NULL, NULL, '2019-12-18 11:33:54', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100012, 'Orgs_Set_Main_Scr', :hC44_81, NULL, NULL, NULL, '2019-12-18 11:34:23', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100014, 'Заблокировать', :hCC5_5, NULL, 1350, 10, '2019-12-18 11:35:14', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100016, 'Роли', NULL, NULL, 1289, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100018, 'Users', :hCCA_45B, NULL, NULL, NULL, '2019-12-18 11:35:43', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100020, 'RolesMenu', :h1125_3B8, NULL, NULL, NULL, '2019-12-18 12:56:18', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100022, 'Roles_AddMenuItem', :h14DD_212, NULL, NULL, NULL, '2019-12-18 11:37:18', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100024, 'Roles_AddMenuItemExec', :h16EF_124, NULL, NULL, NULL, '2019-12-18 11:38:20', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100026, 'Roles_AddRoleCallDialog', :h1813_21, NULL, NULL, NULL, '2019-12-18 11:38:56', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100028, 'Roles_CopyRole', :h1834_1CC, NULL, NULL, NULL, '2019-12-18 11:39:26', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100030, 'Roles_CopyRoleExec', :h1A00_6B, NULL, NULL, NULL, '2019-12-18 11:39:59', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100032, 'Roles_CopyRole_Call', :h1A6B_1E, NULL, NULL, NULL, '2019-12-18 11:41:01', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100034, 'Roles_DelRole', :h1A89_D7, NULL, NULL, NULL, '2019-12-18 11:41:26', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100036, 'Roles_DelRoleExec', :h1B60_58, NULL, NULL, NULL, '2019-12-18 11:41:42', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100038, 'Roles_DelRoleMenuItem', :h1BB8_EF, NULL, NULL, NULL, '2019-12-18 11:42:18', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100040, 'Roles_DelRolesMenuItem', :h1CA7_141, NULL, NULL, NULL, '2019-12-18 11:42:46', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100042, 'Roles_DelRolesMenuItem_Call', :h1DE8_26, NULL, NULL, NULL, '2019-12-18 11:43:03', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100044, 'Roles_Run_Test_RolesMenu', :h1E0E_1C, NULL, NULL, NULL, '2019-12-18 11:45:08', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100046, 'Roles_Test_RolesMenu', :h1E2A_1E1, NULL, NULL, NULL, '2019-12-18 11:45:40', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100048, '-', NULL, NULL, 1311, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100050, 'SQL Mon', :h200B_7, NULL, 1501, 10, '2019-12-18 11:45:55', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100052, 'Set_Org_Scr', :h2012_F9, NULL, NULL, NULL, '2019-12-18 11:46:23', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100054, 'Версия', :h210B_8, NULL, 1901, 10, '2019-12-18 11:46:42', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100056, 'Меню ролей', NULL, 'RolesMenu', 10002, 1289, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100058, 'Настройки', NULL, NULL, 10, NULL, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100060, 'Организации', NULL, 'Orgs', 9002, 2, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100062, 'Параметры', NULL, 'Global_Params', 1401, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100064, 'Пользователи', NULL, 'Users', 10001, 1289, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100066, 'Шаблон приложения DCL5', NULL, NULL, 0, NULL, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100068, 'Справочники', NULL, NULL, 2, NULL, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100070, NULL, NULL, NULL, 20001, NULL, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100072, ' v. 1.2', NULL, NULL, 20052, NULL, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100074, '-', NULL, NULL, 1302, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100076, '-', NULL, NULL, 1500, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100078, '-', NULL, NULL, 1900, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100080, '-', NULL, NULL, 1290, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100082, '09.00.83.181', NULL, NULL, 50000, NULL, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100084, 'User_Edit_Dlg', :h2113_2CD, NULL, NULL, NULL, '2019-12-18 11:47:22', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100086, 'User_Edit_Scr', :h23E0_1D, NULL, NULL, NULL, '2019-12-18 11:48:09', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100088, 'Notify_Add_Scr', :h23FD_BB, NULL, NULL, NULL, '2019-12-18 11:50:55', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100090, 'Notify_Add', :h24B8_1F9, NULL, NULL, NULL, '2019-12-18 11:51:23', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100092, 'Roles_Notify_Add_Scr', :h26B1_29, NULL, NULL, NULL, '2019-12-18 11:52:10', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100094, 'Notifycations', :h26DA_284, NULL, NULL, NULL, '2019-12-18 11:52:51', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100096, 'Global_Params_Edit_Dlg', :h295E_129, '', NULL, NULL, '2019-12-18 11:53:17', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100098, 'Global_Params_Edit_Scr', :h2A87_26, NULL, NULL, NULL, '2019-12-18 11:53:39', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100100, 'Attachments', :h2AAD_3E6, NULL, NULL, NULL, '2019-12-18 11:54:10', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100102, 'Подключения', NULL, 'Attachments', 1300, 10, '2019-12-18 10:47:15', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100104, 'Attachments_Terminate', :h2E93_5B, NULL, NULL, NULL, '2019-12-18 11:55:54', 'U');
INSERT INTO DCL_SCRIPTS (NUMSEQ, DCLNAME, DCLTEXT, COMMAND, IDENT, PARENT, UPDATES, ACTINON) VALUES (100106, 'Выход', :h2EEE_5, NULL, 999, NULL, '2019-12-18 11:56:15', 'U');

COMMIT WORK;

SET BLOBFILE 'DCL_Templates.lob';

INSERT INTO DCL_TEMPLATES (TEID, TEMPL_NAME, TEMPL_DATA) VALUES (1001, 'SaveBS', :h00000000_00000336);
INSERT INTO DCL_TEMPLATES (TEID, TEMPL_NAME, TEMPL_DATA) VALUES (1002, 'LoadBS', :h00000336_00000336);
INSERT INTO DCL_TEMPLATES (TEID, TEMPL_NAME, TEMPL_DATA) VALUES (1003, 'ZIP', :h0000066C_00000336);
INSERT INTO DCL_TEMPLATES (TEID, TEMPL_NAME, TEMPL_DATA) VALUES (1004, 'UnZIP', :h000009A2_00000336);

COMMIT WORK;

INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100004, 100001);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100107, 100160);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100016, 100002);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100014, 100003);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 4, 1055);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 5, 1056);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100008, 100004);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 6, 1057);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 2, 1058);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 3, 1059);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100048, 1060);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100050, 100005);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100054, 100006);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100056, 100007);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100058, 100008);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100060, 100009);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100062, 100010);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100064, 100011);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100066, 100012);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100068, 100013);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100070, 100014);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100072, 100015);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100074, 100016);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100076, 100017);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100078, 100018);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100080, 100019);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100082, 100020);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100008, 100021);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100050, 100022);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100054, 100023);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100058, 100024);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100060, 100025);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100066, 100026);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100068, 100027);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100070, 100028);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100072, 100029);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100074, 100030);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100076, 100031);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100078, 100032);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100080, 100033);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (2, 100082, 100034);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (1, 100102, 100035);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100068, 100036);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100072, 100037);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100082, 100038);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100008, 100039);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100054, 100040);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100058, 100041);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100070, 100042);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100074, 100043);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100076, 100044);
INSERT INTO DCL_ROLESMENU (ROLEID, MENUITEMID, RM_ID) VALUES (3, 100066, 100045);

COMMIT WORK;


/******************************************************************************/
/***                           Unique constraints                           ***/
/******************************************************************************/

ALTER TABLE DCL_GLOBAL_PARAMS ADD CONSTRAINT UNQ1_DCL_GLOBAL_PARAMS UNIQUE (PARAM_USERID, PARAM_NAME);
ALTER TABLE DCL_SCRIPTS ADD CONSTRAINT UNQ1_DCL_SCRIPTS UNIQUE (IDENT);


/******************************************************************************/
/***                              Primary keys                              ***/
/******************************************************************************/

ALTER TABLE DCL_ACTIVE_USERS ADD CONSTRAINT PK_DCL_ACTIVE_USERS PRIMARY KEY (AU_ID);
ALTER TABLE DCL_GLOBAL_PARAMS ADD CONSTRAINT PK_DCL_GLOBAL_PARAMS PRIMARY KEY (PARAM_ID);
ALTER TABLE DCL_INI_PROFILES ADD CONSTRAINT PK_INI_PROFILES PRIMARY KEY (INI_ID);
ALTER TABLE DCL_NOTIFYCATIONS ADD CONSTRAINT PK_DCL_NOTIFYCATIONS PRIMARY KEY (NOTIFY_ID);
ALTER TABLE DCL_ROLES ADD CONSTRAINT PK_DCL_ROLES PRIMARY KEY (ROLESID);
ALTER TABLE DCL_ROLESMENU ADD CONSTRAINT PK_DCL_ROLESMENU PRIMARY KEY (RM_ID);
ALTER TABLE DCL_ROLES_TO_USERS ADD CONSTRAINT PK_DCL_ROLES_TO_USERS PRIMARY KEY (RU_ID);
ALTER TABLE DCL_SCRIPTS ADD CONSTRAINT PK_DCL_SCRIPTS PRIMARY KEY (NUMSEQ);
ALTER TABLE DCL_TEMPLATES ADD CONSTRAINT PK_DCL_TEMPLATES PRIMARY KEY (TEID);
ALTER TABLE DCL_USERS ADD CONSTRAINT PK_DCL_USERS PRIMARY KEY (UID);
ALTER TABLE DCL_USER_LOGIN_HISTORY ADD CONSTRAINT PK_DCL_USER_LOGIN_HISTORY PRIMARY KEY (UL_ID);
ALTER TABLE ORGANIZATIONS ADD CONSTRAINT PK_ORGANIZATIONS PRIMARY KEY (OID);


/******************************************************************************/
/***                              Foreign keys                              ***/
/******************************************************************************/

ALTER TABLE DCL_ACTIVE_USERS ADD CONSTRAINT FK_DCL_ACTIVE_USERS_1 FOREIGN KEY (ACTIVE_USER_ID) REFERENCES DCL_USERS (UID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_INI_PROFILES ADD CONSTRAINT FK_DCL_INI_PROFILES_1 FOREIGN KEY (INI_USER_ID) REFERENCES DCL_USERS (UID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_NOTIFYCATIONS ADD CONSTRAINT FK_DCL_NOTIFYCATIONS_1 FOREIGN KEY (USER_ID) REFERENCES DCL_USERS (UID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_ROLESMENU ADD CONSTRAINT FK_DCL_ROLESMENU_1 FOREIGN KEY (MENUITEMID) REFERENCES DCL_SCRIPTS (NUMSEQ) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_ROLESMENU ADD CONSTRAINT FK_DCL_ROLESMENU_2 FOREIGN KEY (ROLEID) REFERENCES DCL_ROLES (ROLESID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_ROLES_TO_USERS ADD CONSTRAINT FK_DCL_ROLES_TO_USERS_1 FOREIGN KEY (RU_USERID) REFERENCES DCL_USERS (UID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_ROLES_TO_USERS ADD CONSTRAINT FK_DCL_ROLES_TO_USERS_2 FOREIGN KEY (RU_ROLEID) REFERENCES DCL_ROLES (ROLESID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_USERS ADD CONSTRAINT FK_DCL_USERS_1 FOREIGN KEY (DCL_ROLE) REFERENCES DCL_ROLES (ROLESID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE DCL_USER_LOGIN_HISTORY ADD CONSTRAINT FK_DCL_USER_LOGIN_HISTORY_1 FOREIGN KEY (UL_USER_ID) REFERENCES DCL_USERS (UID) ON DELETE CASCADE ON UPDATE CASCADE;


/******************************************************************************/
/***                                Indices                                 ***/
/******************************************************************************/

CREATE INDEX DCL_ROLESMENU_IDX1 ON DCL_ROLESMENU (ROLEID, MENUITEMID);
CREATE INDEX DCL_SCRIPTS_IDX2 ON DCL_SCRIPTS (DCLNAME);
CREATE UNIQUE INDEX DCL_SCRIPTS_IDX3 ON DCL_SCRIPTS (IDENT, PARENT);


/******************************************************************************/
/***                                Triggers                                ***/
/******************************************************************************/


SET TERM ^ ;

/******************************************************************************/
/***                          Triggers for tables                           ***/
/******************************************************************************/

/* Trigger: DCL_ACTIVE_USERS_BI */
CREATE OR ALTER TRIGGER DCL_ACTIVE_USERS_BI FOR DCL_ACTIVE_USERS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.au_id is null) then
    new.au_id = gen_id(gen_dcl_active_users_id,1);
  if (inserting) then
    if (new.active_user_login_time is null) then
      new.active_user_login_time='now';
end
^

/* Trigger: DCL_GLOBAL_PARAMS_BI */
CREATE OR ALTER TRIGGER DCL_GLOBAL_PARAMS_BI FOR DCL_GLOBAL_PARAMS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.param_id is null) then
    new.param_id = gen_id(dcl_main_generator_id, 1);
end
^

/* Trigger: DCL_NOTIFYCATIONS_BI0 */
CREATE OR ALTER TRIGGER DCL_NOTIFYCATIONS_BI0 FOR DCL_NOTIFYCATIONS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.NOTIFY_ID is null) then
    new.NOTIFY_ID = gen_id(DCL_MAIN_GENERATOR_ID, 1);
  if (inserting) then
    new.add_date = 'now';
end
^

/* Trigger: DCL_ROLESMENU_BI */
CREATE OR ALTER TRIGGER DCL_ROLESMENU_BI FOR DCL_ROLESMENU
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.rm_id is null) then
    new.rm_id = gen_id(dcl_main_generator_id, 1);
end
^

/* Trigger: DCL_ROLES_BI */
CREATE OR ALTER TRIGGER DCL_ROLES_BI FOR DCL_ROLES
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.rolesid is null) then
    new.rolesid = gen_id(dcl_main_generator_id, 1);
end
^

/* Trigger: DCL_ROLES_TO_USERS_BI */
CREATE OR ALTER TRIGGER DCL_ROLES_TO_USERS_BI FOR DCL_ROLES_TO_USERS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.ru_id is null) then
    new.ru_id = gen_id(dcl_main_generator_id, 1);
end
^

/* Trigger: DCL_SCRIPTS_BI */
CREATE OR ALTER TRIGGER DCL_SCRIPTS_BI FOR DCL_SCRIPTS
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
as
begin
  if (new.NUMSEQ is null) then
    new.NUMSEQ = gen_id(DCL_SCRIPTS_NEXT_ID, 1);

  new.UPDATES = 'now';
  if (inserting) then
    new.ACTINON = 'I';
  if (updating) then
    new.ACTINON = 'U';
end
^

/* Trigger: DCL_TEMPLATES_BI */
CREATE OR ALTER TRIGGER DCL_TEMPLATES_BI FOR DCL_TEMPLATES
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.teid is null) then
    new.teid = gen_id(dcl_main_generator_id, 1);
end
^

/* Trigger: DCL_USERS_BI */
CREATE OR ALTER TRIGGER DCL_USERS_BI FOR DCL_USERS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.uid is null) then
    new.uid = gen_id(dcl_main_generator_id, 1);
end
^

/* Trigger: DCL_USER_LOGIN_HISTORY_BI */
CREATE OR ALTER TRIGGER DCL_USER_LOGIN_HISTORY_BI FOR DCL_USER_LOGIN_HISTORY
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.UL_ID is null) then
    new.UL_ID = gen_id(GEN_DCL_USER_LOGIN_HISTORY_ID, 1);
end
^

/* Trigger: INI_PROFILES_BI */
CREATE OR ALTER TRIGGER INI_PROFILES_BI FOR DCL_INI_PROFILES
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.ini_id is null) then
    new.ini_id = gen_id(gen_ini_profiles_id, 1);
end
^

/* Trigger: ORGANIZATIONS_BI */
CREATE OR ALTER TRIGGER ORGANIZATIONS_BI FOR ORGANIZATIONS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.oid is null) then
    new.oid = gen_id(dcl_main_generator_id, 1);
end
^
SET TERM ; ^


/******************************************************************************/
/***                           Stored procedures                            ***/
/******************************************************************************/


SET TERM ^ ;

CREATE OR ALTER PROCEDURE ADD_MENU_ITEM_TO_ROLE (
    ROLEID INTEGER,
    MENUITEMID INTEGER)
RETURNS (
    ISAPPEND INTEGER)
AS
declare variable TMP1 integer;
begin
  select count(R.ROLEID)
  from DCL_ROLESMENU R
  where R.ROLEID = :ROLEID and
        R.MENUITEMID = :MENUITEMID
  into TMP1;
  if (:TMP1 = 0) then
  begin
    insert into DCL_ROLESMENU (ROLEID, MENUITEMID)
    values (:ROLEID, :MENUITEMID);
    ISAPPEND = 1;
    suspend;
  end
  else
  begin
    ISAPPEND = 0;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE COPY_ROLE (
    ROLEIDFROM INTEGER,
    ROLEIDTO INTEGER)
AS
begin
  insert into DCL_ROLESMENU(ROLEID, MENUITEMID)
  select :ROLEIDTO, MENUITEMID
  from DCL_ROLESMENU R
  where R.ROLEID = :ROLEIDFROM;
end^


CREATE OR ALTER PROCEDURE DEL_ROLE_AND_MENU (
    ROLEID INTEGER)
AS
begin
  delete from DCL_rolesmenu r where r.roleid=:roleid and r.roleid not in (select u1.dcl_role from dcl_users u1);
  Delete from DCL_roles r where r.rolesid=:roleid and r.rolesid not in (select u1.dcl_role from dcl_users u1);
end^


CREATE OR ALTER PROCEDURE DEL_ROLE_MENU (
    ROLEID INTEGER)
AS
begin
    delete from DCL_rolesmenu r where r.roleid=:roleid and r.roleid not in (select u1.dcl_role from dcl_users u1);
end^


CREATE OR ALTER PROCEDURE FIRST_DAY_OF_MONTH (
    ADATE DATE)
RETURNS (
    RESULT DATE)
AS
begin
if (:adate is null) then adate='now';
Result=ADate-EXTRACT(DAY FROM ADate) + 1;
  suspend;
end^


CREATE OR ALTER PROCEDURE IS_NUMBER (
    A_VALUE VARCHAR(32))
RETURNS (
    RESULT INTEGER)
AS
declare variable I integer;
declare variable J integer;
begin
  result = 0;
  a_value = trim(a_value);
  IF (a_value IS NULL OR char_length(a_value) = 0) then begin
    suspend;
    exit;
  end
  i = 1;
  j = CHAR_LENGTH(a_value);
  while (i <= j) do begin
    IF (substring(a_value FROM i FOR 1) BETWEEN '0' AND '9'
     OR (i =1 AND substring(a_value FROM 1 FOR 1) IN ('-', '+')
       AND CHAR_LENGTH(a_value) > 1 )) then
      result = 1;
    else begin
      result = 0;
      Break;
    end
    i = i + 1;
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE ROLESMENU_IS_CORRECT
RETURNS (
    NUMSEQ INTEGER,
    DCLNAME VARCHAR(50),
    IDENT INTEGER,
    ROLE_ID INTEGER,
    ROLE_NAME VARCHAR(50))
AS
declare variable HEAD_EXISTS integer;
declare variable PARENT integer;
begin
for select r.rolesid, r.longrolename from DCL_roles r order by r.longrolename into :role_id, :role_name do
for select d.numseq, d.ident, d.parent from DCL_RolesMenu rm, DCL_Roles r, DCL_SCRIPTS d where r.rolesid=rm.roleid and rm.MENUITEMID=d.numseq and r.rolesid=:role_id into :numseq, :ident, :parent do
begin
    select count(*) from DCL_RolesMenu rm, DCL_Roles r, DCL_SCRIPTS d where r.rolesid=rm.roleid and rm.MENUITEMID=d.numseq and d.ident=:parent and r.rolesid=:role_id into :head_exists;
    if (:head_exists=0) then
    begin
        for select s.numseq, s.dclname, s.ident from DCL_scripts s where s.ident=:parent into :numseq, :dclname, :ident do suspend;
    end
end
end^


SET TERM ; ^

/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

COMMENT ON TABLE DCL_GLOBAL_PARAMS IS
'Параметры запуска системы';

COMMENT ON TABLE DCL_INI_PROFILES IS
'Параметры диалогов';

COMMENT ON TABLE DCL_NOTIFYCATIONS IS
'Сообщения';

COMMENT ON TABLE DCL_ROLESMENU IS
'Меню ролей';

COMMENT ON TABLE DCL_ROLES_TO_USERS IS
'Таблица множественной связи ролей с пользователем';

COMMENT ON TABLE DCL_SCRIPTS IS
'Скрипты';

COMMENT ON TABLE DCL_TEMPLATES IS
'Шаблоны отчётов';

COMMENT ON TABLE DCL_USER_LOGIN_HISTORY IS
'История подключений';

COMMENT ON TABLE ORGANIZATIONS IS
'Организации';


/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

COMMENT ON PROCEDURE ADD_MENU_ITEM_TO_ROLE IS
'Добавление пункта меню к роли';

COMMENT ON PROCEDURE COPY_ROLE IS
'Копирование роли';

COMMENT ON PROCEDURE FIRST_DAY_OF_MONTH IS
'Первый день месяца';

COMMENT ON PROCEDURE IS_NUMBER IS
'Проверка является ли строка числом';

COMMENT ON PROCEDURE ROLESMENU_IS_CORRECT IS
'Проверка корректности меню ролей';


/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

COMMENT ON GENERATOR DCL_MAIN_GENERATOR_ID IS
'Один счётчик на всех';


/******************************************************************************/
/***                          Fields descriptions                           ***/
/******************************************************************************/

COMMENT ON COLUMN DCL_ROLESMENU.ROLEID IS
'ID роли';

COMMENT ON COLUMN DCL_ROLESMENU.MENUITEMID IS
'ID элемента меню к роли';

